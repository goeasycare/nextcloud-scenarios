name: Argo CD Manual Sync

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh Argo CD Application
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN: ${{ secrets.ARGOCD_TOKEN }}
        run: |
          if [ -z "$ARGOCD_SERVER" ]; then
            echo "Error: ARGOCD_SERVER secret is not set."
            exit 1
          fi
          if [ -z "$ARGOCD_TOKEN" ]; then
            echo "Error: ARGOCD_TOKEN secret is not set."
            exit 1
          fi

          curl -X POST \
            -H "Authorization: Bearer $ARGOCD_TOKEN" \
            -k "https://${ARGOCD_SERVER}/api/v1/applications/nextcloud/sync"
